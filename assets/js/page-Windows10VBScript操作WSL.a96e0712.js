(window.webpackJsonp=window.webpackJsonp||[]).push([[36],{794:function(s,t,n){"use strict";n.r(t);var a=n(1),r=Object(a.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"windows10-vbscript-操作-wsl"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#windows10-vbscript-操作-wsl"}},[s._v("#")]),s._v(" Windows10 VBScript 操作 WSL")]),s._v(" "),n("h2",{attrs:{id:"回顾"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#回顾"}},[s._v("#")]),s._v(" 回顾")]),s._v(" "),n("p",[s._v("根据文章"),n("RouterLink",{attrs:{to:"/blog/ops/WSL/docs-hope/blog/ops/WSL/WSL2.html"}},[s._v("Windows10 WSL2网络通信")]),s._v("中使用到的VBScript脚本，看起来有些乱，接下来是对脚本的改造")],1),s._v(" "),n("h2",{attrs:{id:"设想"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#设想"}},[s._v("#")]),s._v(" 设想")]),s._v(" "),n("p",[s._v("根据脚本，我觉得有一些地方需要进行改造，使它更容易阅读，以及针对后续的端口更改等操作更加的方便")]),s._v(" "),n("blockquote",[n("ol",[n("li",[s._v("脚本重构，使其更容易阅读")]),s._v(" "),n("li",[s._v("抽象端口映射关系，在后续如果新增新的端口，可以更加的方便")]),s._v(" "),n("li",[s._v("重构之前指令可能会出问题的逻辑")])])]),s._v(" "),n("h2",{attrs:{id:"重构之后的脚本"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#重构之后的脚本"}},[s._v("#")]),s._v(" 重构之后的脚本")]),s._v(" "),n("p",[s._v("根据上述的设想，对脚本重构：")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("\n"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("' 获取管理员权限\nfunction get_administrator_permission()\n        '")]),s._v(" 获取管理员权限\n        Set WshShell "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" WScript.CreateObject"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"WScript.Shell"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        If WScript.Arguments.Length "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" Then\n        Set ObjShell "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" CreateObject"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Shell.Application"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        ObjShell.ShellExecute "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"wscript.exe"')]),s._v(" _\n                , "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v('"'),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('" & WScript.ScriptFullName & "')]),s._v('"'),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('" RunAsAdministrator"')]),s._v(", , "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"runas"')]),s._v(", "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n        WScript.Quit\n        End "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v("\nend "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("' 定义端口映射关系\nfunction port_map_dictionary()\n        Dim map\n        '")]),s._v(" 创建一个端口映射字典\n        "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" map "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" CreateObject"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Scripting.Dictionary"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        map.CompareMode "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" vbTextCompare\n        map.Add "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"9000"')]),s._v(", "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"9000"')]),s._v("\n        map.Add "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"9090"')]),s._v(", "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"9090"')]),s._v("\n\n        "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" port_map_dictionary "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" map\nend "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("' 启动wsl系统\nfunction open_wsl(ws)\n        '")]),s._v(" 开启wsl子系统，并执行子系统初始化脚本\n        ws.run "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"wsl -d Ubuntu-20.04 -u root /etc/init_service.sh"')]),s._v(",0\nend "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("' 获取wslip地址\nfunction get_wsl_ip(ws)\n        '")]),s._v(" 查询wsl子系统ip\n        commandLine "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"wsl -d Ubuntu-20.04 -u root /opt/wsl_ip/wsl_ip.sh"')]),s._v("\n        Set result "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ws.Exec"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("commandLine"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("' 处理ip\n        ipaddr = result.StdOut.ReadAll()\n        ipLength = Len(ipaddr)\n        ip = Left(ipaddr, ipLength - 1)\n        get_wsl_ip = ip\nend function\n\n'")]),s._v(" 处理cmd端口转发指令\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" get_cmd_command"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ip"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("' 定义一些变量\n        Dim port_map, cmd_array()\n        '")]),s._v(" 获取端口映射关系\n        "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" port_map "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" port_map_dictionary"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("' 获取端口映射字典数量，并重置cmd数组定义\n        ReDim cmd_array(UBound(port_map.Keys))\n        '")]),s._v(" 查询windows所有转发的端口\n        "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("' netsh interface portproxy show all\n        '")]),s._v(" 删除端口转发\n        "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("' netsh interface portproxy delete v4tov4 listenport=9091 listenaddress=0.0.0.0\n        '")]),s._v(" 定义cmd指令临时变量\n        interface_cmd "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"netsh interface portproxy add v4tov4 listenport=listen_port listenaddress=0.0.0.0 connectport=poxt_port connectaddress="')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('" protocol=tcp"')]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("' 定义cmd数组下表索引临时变量\n        cmd_index = 0\n        '")]),s._v(" 循环端口映射字典，并拼接端口转发cmd指令\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" each i "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" port_map.Keys\n                "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("' 本地端口\n                listen_port = i\n                '")]),s._v(" 监听代理的linux端口\n                poxt_port "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" port_map"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                my_cmd "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Replace"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("interface_cmd, "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"listen_port"')]),s._v(", listen_port"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                my_cmd "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Replace"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("my_cmd, "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"poxt_port"')]),s._v(", poxt_port"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("' 新增到cmd数组种\n                cmd_array(cmd_index) = my_cmd\n                '")]),s._v(" 索引 +1\n                cmd_index "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cmd_index + "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n        Next\n        "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("' 往cmd数组中做拼接, 不能使用拼接的方式执行\n        '")]),s._v("get_cmd_command "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" join"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cmd_array, "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('";"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        get_cmd_command "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cmd_array\n        "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("' WScript.echo cmd_command\nend function\n\n'")]),s._v(" 执行cmd指令\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" execut_cmd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ws, cmd_array"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" each cmd "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" get_cmd_command"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("wsl_ip"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                ws.run cmd,0\n        Next\nend "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v("\n\n\n' 主程序运行区\nDim wsl_ip, cmd_command\n\nget_administrator_permission"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nSet ws "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" WScript.CreateObject"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"WScript.Shell"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nopen_wsl"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ws"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nwsl_ip "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" get_wsl_ip"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ws"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nexecut_cmd ws,get_cmd_command"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("wsl_ip"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br"),n("span",{staticClass:"line-number"},[s._v("85")]),n("br"),n("span",{staticClass:"line-number"},[s._v("86")]),n("br"),n("span",{staticClass:"line-number"},[s._v("87")]),n("br"),n("span",{staticClass:"line-number"},[s._v("88")]),n("br"),n("span",{staticClass:"line-number"},[s._v("89")]),n("br"),n("span",{staticClass:"line-number"},[s._v("90")]),n("br"),n("span",{staticClass:"line-number"},[s._v("91")]),n("br"),n("span",{staticClass:"line-number"},[s._v("92")]),n("br"),n("span",{staticClass:"line-number"},[s._v("93")]),n("br"),n("span",{staticClass:"line-number"},[s._v("94")]),n("br")])]),n("h2",{attrs:{id:"仍然存在的问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#仍然存在的问题"}},[s._v("#")]),s._v(" 仍然存在的问题")]),s._v(" "),n("p",[s._v("脚本虽然写了，但是这里还是存在一些问题：")]),s._v(" "),n("ol",[n("li",[s._v("WSL系统中的eth0所指向的ip必须只能有一个")]),s._v(" "),n("li",[s._v("使用VBScript脚本无法一次执行多个CMD指令")])]),s._v(" "),n("h2",{attrs:{id:"参考文献"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#参考文献"}},[s._v("#")]),s._v(" 参考文献")]),s._v(" "),n("p",[s._v("- [1] "),n("a",{attrs:{href:"https://www.jb51.net/shouce/vbscript/",target:"_blank",rel:"noopener noreferrer"}},[s._v("微软官方VBScript参考手册"),n("OutboundLink")],1)]),n("p"),n("p")])}),[],!1,null,null,null);t.default=r.exports}}]);